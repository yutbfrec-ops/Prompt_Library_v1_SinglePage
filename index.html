<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt 詞庫 v1（離線單頁版）</title>
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
      --brand:#2563eb; --brand2:#0ea5e9; --ok:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08); --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC","Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--text);
      background:linear-gradient(180deg,#eef2ff 0%, var(--bg) 40%, var(--bg) 100%);}
    header{position:sticky;top:0;z-index:20;background:rgba(247,248,251,.9);
      backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:1160px;margin:0 auto;padding:14px 16px;}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{display:flex;gap:12px;align-items:flex-start;}
    .badge{font-size:12px;padding:3px 10px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);background:#fff;white-space:nowrap;}
    h1{font-size:18px;margin:0;line-height:1.25}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer;
      box-shadow:0 1px 0 rgba(15,23,42,.02);
      transition:.15s transform,.15s box-shadow,.15s border-color;font-family:var(--sans);}
    button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.08);border-color:#cbd5e1}
    button.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#fff}
    button.ok{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:transparent;color:#fff}
    button.ghost{background:transparent}
    .grid{display:grid;gap:14px;grid-template-columns: 1.05fr .95fr;align-items:start;padding:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;}
    .card h2{font-size:14px;margin:0;padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .card h2 small{color:var(--muted);font-weight:500}
    .content{padding:14px 16px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    @media (max-width: 560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    select,input[type="text"],textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;font-family:var(--sans);color:var(--text);outline:none;}
    textarea{min-height:110px;resize:vertical;font-family:var(--mono);font-size:12px;line-height:1.45}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-size:12px;color:var(--muted);cursor:pointer;user-select:none;}
    .chip input{margin:0}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;font-size:12px;color:var(--muted);cursor:pointer;user-select:none;}
    .pill.active{border-color:#93c5fd;background:#eff6ff;color:#1d4ed8;font-weight:700}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;}
    .item .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .tag{font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted);background:#fff;white-space:nowrap;}
    .item h3{font-size:13px;margin:8px 0 6px}
    .item pre{margin:0;padding:10px 12px;border-radius:12px;background:#0b1220;color:#e2e8f0;
      overflow:auto;font-size:12px;line-height:1.5;font-family:var(--mono);}
    .item .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0b1220;color:#e2e8f0;padding:10px 14px;border-radius:999px;font-size:12px;
      box-shadow:0 18px 35px rgba(2,6,23,.35);
      opacity:0;pointer-events:none;transition:.25s opacity,.25s transform;z-index:50;max-width:92vw;text-align:center;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
    .mini{font-size:12px;color:var(--muted)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1;min-width:180px;border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px}
    .kpi .box b{display:block;font-size:16px;margin-top:2px}
    .footer{padding:18px 16px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div>
          <h1>Prompt 詞庫 v1（離線單頁內部工具）</h1>
          <div class="subtitle">適用：ComfyUI / SD1.5 文生圖背景素材。無後端、可放 GitHub Pages、手機與電腦瀏覽器可用。</div>
        </div>
        <span class="badge">Build v1.0</span>
      </div>
      <div class="actions">
        <button class="ghost" id="btnReset">重置表單</button>
        <button class="primary" id="btnCopyAll">複製「正向 + 負向」</button>
        <button class="ok" id="btnCopyPos">只複製正向</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>
        <span>Prompt 生成器 <small>用「選單 + 問卷式」填空</small></span>
        <small class="mini">建議：先選「場景模板」→ 再微調材質/光線</small>
      </h2>
      <div class="content">
        <div class="row">
          <div>
            <label>電商產品類別（用於補充常見攝影語彙）</label>
            <select id="selProduct"></select>
          </div>
          <div>
            <label>輸出語言</label>
            <select id="selLang">
              <option value="en" selected>英文（建議，兼容 SD/模型）</option>
              <option value="zh">中文（便於理解，但部分模型效果不穩）</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>場景模板（最快）</label>
            <select id="selTemplate"></select>
          </div>
          <div>
            <label>材質/主體（可覆蓋模板材質）</label>
            <select id="selMaterial"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>構圖/視角</label>
            <select id="selComposition"></select>
          </div>
          <div>
            <label>光線</label>
            <select id="selLight"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>品質/風格（建議固定）</label>
            <select id="selQuality"></select>
          </div>
          <div>
            <label>可平鋪/可重複（材質背景推薦勾選）</label>
            <div class="chips" style="margin-top:0">
              <label class="chip"><input type="checkbox" id="chkTileable" checked> tileable / seamless</label>
              <label class="chip"><input type="checkbox" id="chkCopySpace" checked> copy space</label>
              <label class="chip"><input type="checkbox" id="chkMinimal" checked> minimal / clean</label>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>額外關鍵字（逗號分隔，選填）</label>
            <input id="txtExtra" type="text" placeholder="例如：neutral color grading, soft shadow, matte surface" />
          </div>
          <div>
            <label>排除標籤（Negative Prompt 追加，逗號分隔）</label>
            <input id="txtNegExtra" type="text" placeholder="例如：overexposed, plastic look, noisy" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>正向 Prompt（可手動修改）</label>
            <textarea id="outPos"></textarea>
          </div>
          <div>
            <label>負向 Prompt（電商背景建議固定）</label>
            <textarea id="outNeg"></textarea>
          </div>
        </div>

        <div class="hint">
          使用方式：把「正向」貼到 ComfyUI 的 prompt，把「負向」貼到 negative。若你 workflow 沒有 negative 欄位，也可以把負向當作排除詞加在正向後面（效果較弱）。
        </div>
      </div>
    </section>

    <section class="card">
      <h2>
        <span>常用詞庫 <small>Hardcode（電商夠用）</small></span>
        <small class="mini" id="countInfo"></small>
      </h2>
      <div class="content">
        <div class="row">
          <div>
            <label>快速篩選</label>
            <input id="txtSearch" type="text" placeholder="搜尋：tile, studio, grass, beach, sky, marble..." />
          </div>
          <div>
            <label>類型</label>
            <select id="selFilterType"></select>
          </div>
        </div>

        <div class="pillbar" id="quickPills"></div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="mini">你目前的目標</div>
            <b>快速產出可用背景</b>
            <div class="mini">比「像藝術」更重要</div>
          </div>
          <div class="box">
            <div class="mini">建議工作流策略</div>
            <b>SD1.5 先出量</b>
            <div class="mini">Z-Image OOM 時不要硬扛</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="libList"></div>

        <div class="footer">
          單檔案離線工具：可直接丟到 GitHub Pages。若要擴充詞庫，搜尋 <span style="font-family:var(--mono)">LIBRARY</span> 陣列新增項目即可。
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast">已複製</div>

<script>
const DEFAULT_NEG = [
  "text","logo","watermark","people","hands","product","products","clutter","messy",
  "stain","stains","crack","cracks","mold","dirt","graffiti",
  "blur","blurry","lowres","jpeg artifacts","distorted perspective","fisheye","tilt",
  "harsh shadow","vignette","overexposed","underexposed"
].join(", ");

const PRODUCT_HINTS = {
  "home_textile": ["soft shadow","matte surface","neutral color grading"],
  "blanket": ["cozy","soft diffused light","texture detail"],
  "bag": ["clean studio","subtle reflection","sharp edges"],
  "toy": ["bright but soft light","clean background","high detail"],
  "tape": ["clean studio","product photography background","minimal"]
};

const PRODUCTS = [
  {id:"home_textile", name:"家居紡織品（枕套/床品/窗簾）"},
  {id:"blanket", name:"毛毯 / 蓋毯"},
  {id:"bag", name:"箱包（背包/收納包）"},
  {id:"toy", name:"玩具"},
  {id:"tape", name:"膠帶"}
];

const TEMPLATES = [
  {id:"web-soft-gradient", name:"網頁常用：柔和漸層留白", type:"web",
    pos:"minimal soft gradient background, subtle light falloff, clean modern, large copy space, high detail, neutral color grading"},
  {id:"web-paper", name:"網頁常用：白紙/卡紙質感", type:"web",
    pos:"clean white paper texture background, subtle paper grain, minimal, large copy space, soft diffused light, high detail"},
  {id:"studio-wall", name:"攝影棚：純牆面（留白）", type:"studio",
    pos:"product photography background, clean studio wall backdrop, smooth matte wall, large copy space, soft diffused light, gentle shadow, high detail"},
  {id:"studio-wall-table", name:"攝影棚：牆 + 桌面（最常用）", type:"studio",
    pos:"product photography background, clean studio wall and matte tabletop, front view, large copy space, soft daylight from left, gentle shadow, high detail"},
  {id:"texture-mosaic", name:"材質：馬賽克磁磚牆面/紋理", type:"texture",
    pos:"mosaic ceramic tiles texture, small square tiles, clean grout lines, neutral white and light gray, studio lighting, high detail, sharp focus"},
  {id:"texture-concrete", name:"材質：水泥牆面（質感背景）", type:"texture",
    pos:"concrete wall texture background, subtle roughness, clean surface, neutral gray, soft diffused light, high detail, minimal"},
  {id:"texture-wood", name:"材質：木紋桌面/背景", type:"texture",
    pos:"natural wood texture background, subtle wood grain, matte finish, clean surface, soft diffused light, high detail, minimal"},
  {id:"texture-marble", name:"材質：大理石（高級感）", type:"texture",
    pos:"marble texture background, clean polished marble surface, subtle veining, soft diffused light, high detail, premium minimal"},
  {id:"texture-fabric", name:"材質：布料（家紡/毛毯常用）", type:"texture",
    pos:"soft fabric texture background, subtle weave, clean surface, soft diffused light, high detail, minimal"},
  {id:"outdoor-grass-45", name:"戶外：45度角草地", type:"outdoor",
    pos:"outdoor grass background at 45 degree angle, fresh green lawn, soft daylight, natural look, large copy space, high detail"},
  {id:"outdoor-beach-topdown", name:"戶外：俯視沙灘", type:"outdoor",
    pos:"top-down beach sand background, clean fine sand texture, soft sunlight, minimal, large copy space, high detail"},
  {id:"outdoor-sea-topdown", name:"戶外：俯視海水/泳池水面", type:"outdoor",
    pos:"top-down clear water surface background, gentle ripples, clean minimal, soft sunlight, large copy space, high detail"},
  {id:"outdoor-sky", name:"戶外：藍天白雲留白", type:"outdoor",
    pos:"blue sky with soft white clouds background, clean minimal, large copy space, natural daylight, high detail"}
];

const MATERIALS = [
  {id:"auto", name:"（跟模板走）"},
  {id:"mosaic tiles", name:"馬賽克磁磚"},
  {id:"concrete wall", name:"水泥牆面"},
  {id:"plaster wall", name:"粉刷白牆"},
  {id:"paper texture", name:"紙張/卡紙"},
  {id:"linen fabric", name:"亞麻布料"},
  {id:"soft fabric", name:"柔軟布料（通用）"},
  {id:"wood surface", name:"木紋表面"},
  {id:"marble surface", name:"大理石表面"},
  {id:"beach sand", name:"沙灘細沙"},
  {id:"clear water surface", name:"清澈水面（海/泳池）"},
  {id:"green grass", name:"草地"},
  {id:"blue sky", name:"藍天白雲"}
];

const COMPOSITIONS = [
  {id:"front wall", name:"正面牆面（留白）", pos:"front view, wall backdrop, large copy space"},
  {id:"wall+table", name:"牆 + 桌面（產品常用）", pos:"front view, wall and tabletop, large copy space"},
  {id:"top-down", name:"俯視（flat lay）", pos:"top-down flat lay, evenly framed, minimal"},
  {id:"45deg", name:"45度角", pos:"45 degree angle, natural perspective, minimal"},
  {id:"corner", name:"角落構圖（牆角/轉角）", pos:"corner composition, clean lines, large copy space"}
];

const LIGHTS = [
  {id:"soft", name:"柔光（棚拍）", pos:"soft diffused studio light, gentle shadow"},
  {id:"day-left", name:"自然光：左側入光", pos:"soft daylight from left, gentle shadow"},
  {id:"day-right", name:"自然光：右側入光", pos:"soft daylight from right, gentle shadow"},
  {id:"overcast", name:"陰天散射光", pos:"overcast daylight, soft even lighting"}
];

const QUALITIES = [
  {id:"sd15", name:"SD1.5 穩定（推薦）", pos:"clean minimal, high detail, sharp focus, neutral color grading"},
  {id:"premium", name:"高級感（A+ 常用）", pos:"premium minimal, elegant, high detail, sharp focus, subtle warm tone"},
  {id:"bright", name:"清爽明亮", pos:"bright clean minimal, high detail, sharp focus, soft shadow"}
];

const LIBRARY = [
  {id:"web1", type:"web", title:"柔和漸層留白（通用落地頁/海報底）",
    pos:"minimal soft gradient background, subtle light falloff, clean modern, large copy space, high detail, neutral color grading",
    neg:DEFAULT_NEG},
  {id:"web2", type:"web", title:"白紙/卡紙底（網頁設計常用）",
    pos:"clean white paper texture background, subtle paper grain, minimal, large copy space, soft diffused light, high detail",
    neg:DEFAULT_NEG},
  {id:"studio1", type:"studio", title:"攝影棚純牆面（留白）",
    pos:"product photography background, clean studio wall backdrop, smooth matte wall, large copy space, soft diffused light, gentle shadow, high detail",
    neg:DEFAULT_NEG},
  {id:"studio2", type:"studio", title:"攝影棚牆 + 桌面（最常用）",
    pos:"product photography background, clean studio wall and matte tabletop, front view, large copy space, soft daylight from left, gentle shadow, high detail",
    neg:DEFAULT_NEG},
  {id:"tex1", type:"texture", title:"馬賽克磁磚紋理（可平鋪素材）",
    pos:"tileable seamless texture, mosaic ceramic tiles, small square tiles, clean grout lines, top-down flat lay, soft diffused light, clean minimal, high detail, sharp focus",
    neg:DEFAULT_NEG},
  {id:"tex2", type:"texture", title:"水泥牆面（品牌質感背景）",
    pos:"tileable seamless texture, concrete wall texture background, subtle roughness, clean surface, neutral gray, soft diffused light, high detail, minimal",
    neg:DEFAULT_NEG},
  {id:"tex3", type:"texture", title:"木紋桌面（溫暖中性）",
    pos:"tileable seamless texture, natural wood texture background, subtle wood grain, matte finish, clean surface, soft diffused light, high detail, minimal",
    neg:DEFAULT_NEG},
  {id:"tex4", type:"texture", title:"大理石背景（高級感）",
    pos:"tileable seamless texture, marble texture background, clean polished marble surface, subtle veining, soft diffused light, high detail, premium minimal",
    neg:DEFAULT_NEG},
  {id:"tex5", type:"texture", title:"布料底（家紡/毛毯常用）",
    pos:"tileable seamless texture, soft fabric texture background, subtle weave, clean surface, soft diffused light, high detail, minimal",
    neg:DEFAULT_NEG},
  {id:"out1", type:"outdoor", title:"45度角草地（戶外氛圍）",
    pos:"outdoor grass background at 45 degree angle, fresh green lawn, soft daylight, natural look, large copy space, high detail",
    neg:DEFAULT_NEG},
  {id:"out2", type:"outdoor", title:"俯視沙灘（夏季/海灘風）",
    pos:"top-down beach sand background, clean fine sand texture, soft sunlight, minimal, large copy space, high detail",
    neg:DEFAULT_NEG},
  {id:"out3", type:"outdoor", title:"俯視水面（海水/泳池）",
    pos:"top-down clear water surface background, gentle ripples, clean minimal, soft sunlight, large copy space, high detail",
    neg:DEFAULT_NEG},
  {id:"out4", type:"outdoor", title:"藍天白雲（留白背景）",
    pos:"blue sky with soft white clouds background, clean minimal, large copy space, natural daylight, high detail",
    neg:DEFAULT_NEG}
];

const $ = (id)=>document.getElementById(id);
const toast = $("toast");

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 1300);
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); showToast("已複製到剪貼簿"); }
  catch(e){
    const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove(); showToast("已複製（fallback）");
  }
}
function fillSelect(sel, options){
  sel.innerHTML = options.map(o=>`<option value="${o.id}">${o.name}</option>`).join("");
}
function uniq(arr){return [...new Set(arr)]}

fillSelect($("selProduct"), [{id:"", name:"（不指定）"}, ...PRODUCTS]);
fillSelect($("selTemplate"), [{id:"", name:"（不使用模板）"}, ...TEMPLATES]);
fillSelect($("selMaterial"), MATERIALS);
fillSelect($("selComposition"), COMPOSITIONS);
fillSelect($("selLight"), LIGHTS);
fillSelect($("selQuality"), QUALITIES);

const TYPES = [{id:"all", name:"全部"}, ...uniq(LIBRARY.map(x=>x.type)).map(t=>({id:t, name:t.toUpperCase()}))];
fillSelect($("selFilterType"), TYPES);

const pills = [
  {id:"tileable", label:"可平鋪"},
  {id:"studio", label:"棚拍背景"},
  {id:"outdoor", label:"戶外背景"},
  {id:"texture", label:"材質紋理"},
  {id:"copyspace", label:"留白"}
];
$("quickPills").innerHTML = pills.map(p=>`<span class="pill" data-pill="${p.id}">${p.label}</span>`).join("");

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function applyItem(item){
  $("outPos").value = item.pos;
  $("outNeg").value = item.neg || DEFAULT_NEG;
  showToast("已套用詞庫配方");
}
window.applyItemById = (id)=>{ const it = LIBRARY.find(x=>x.id===id); if(it) applyItem(it); };
window.copyPosById = async (id)=>{ const it = LIBRARY.find(x=>x.id===id); if(it) await copyText(it.pos); };
window.copyAllById = async (id)=>{
  const it = LIBRARY.find(x=>x.id===id); if(!it) return;
  await copyText(`POSITIVE:
${it.pos}

NEGATIVE:
${it.neg || DEFAULT_NEG}`);
};

function renderLibrary(){
  const q = ($("txtSearch").value || "").toLowerCase().trim();
  const type = $("selFilterType").value;
  const filtered = LIBRARY.filter(it=>{
    const okType = (type==="all") ? true : it.type===type;
    const text = (it.title + " " + it.pos + " " + (it.neg||"")).toLowerCase();
    const okQ = q ? text.includes(q) : true;
    return okType && okQ;
  });
  $("countInfo").textContent = `共 ${filtered.length} 條（Hardcode）`;
  $("libList").innerHTML = filtered.map(it=>`
    <div class="item">
      <div class="meta">
        <span class="tag">${it.type.toUpperCase()}</span>
        <span class="mini">${it.id}</span>
      </div>
      <h3>${it.title}</h3>
      <div class="mini" style="margin:6px 0 6px">正向</div>
      <pre>${escapeHtml(it.pos)}</pre>
      <div class="mini" style="margin:8px 0 6px">負向</div>
      <pre>${escapeHtml(it.neg || DEFAULT_NEG)}</pre>
      <div class="btns">
        <button class="primary" onclick="(function(){applyItemById('${it.id}')})()">套用到生成器</button>
        <button onclick="(function(){copyPosById('${it.id}')})()">複製正向</button>
        <button onclick="(function(){copyAllById('${it.id}')})()">複製正向+負向</button>
      </div>
    </div>
  `).join("");
}

function buildFromForm(){
  const lang = $("selLang").value;
  const product = $("selProduct").value;
  const tplId = $("selTemplate").value;
  const matId = $("selMaterial").value;
  const compId = $("selComposition").value;
  const lightId = $("selLight").value;
  const qualId = $("selQuality").value;

  const extra = ($("txtExtra").value || "").trim();
  const negExtra = ($("txtNegExtra").value || "").trim();

  const tpl = TEMPLATES.find(x=>x.id===tplId);
  const mat = MATERIALS.find(x=>x.id===matId);
  const comp = COMPOSITIONS.find(x=>x.id===compId);
  const light = LIGHTS.find(x=>x.id===lightId);
  const qual = QUALITIES.find(x=>x.id===qualId);

  let parts = [];
  if(tpl) parts.push(tpl.pos); else parts.push("product photo background");
  if(mat && mat.id !== "auto") parts.push(mat.id);
  if(comp) parts.push(comp.pos);
  if(light) parts.push(light.pos);
  if(qual) parts.push(qual.pos);

  if($("chkTileable").checked) parts.push("tileable seamless");
  if($("chkCopySpace").checked) parts.push("large copy space");
  if($("chkMinimal").checked) parts.push("clean minimal");

  if(product && PRODUCT_HINTS[product]) parts.push(...PRODUCT_HINTS[product]);
  if(extra) parts.push(extra);

  let pos = parts.join(", ").replace(/\s+/g," ").replace(/,\s*,/g,", ").trim();
  let neg = DEFAULT_NEG + (negExtra ? (", " + negExtra) : "");

  if(lang === "zh") pos = "（建議仍用英文）\n" + pos;

  $("outPos").value = pos;
  $("outNeg").value = neg;
}

$("btnCopyPos").addEventListener("click", async ()=> copyText($("outPos").value.trim()));
$("btnCopyAll").addEventListener("click", async ()=> copyText(`POSITIVE:
${$("outPos").value.trim()}

NEGATIVE:
${$("outNeg").value.trim()}`));

$("btnReset").addEventListener("click", ()=>{
  $("selProduct").value = "";
  $("selLang").value = "en";
  $("selTemplate").value = "studio-wall-table";
  $("selMaterial").value = "auto";
  $("selComposition").value = "wall+table";
  $("selLight").value = "day-left";
  $("selQuality").value = "sd15";
  $("chkTileable").checked = true;
  $("chkCopySpace").checked = true;
  $("chkMinimal").checked = true;
  $("txtExtra").value = "";
  $("txtNegExtra").value = "";
  buildFromForm();
  showToast("已重置");
});

$("quickPills").addEventListener("click", (e)=>{
  const pill = e.target.closest(".pill"); if(!pill) return;
  const id = pill.dataset.pill; pill.classList.toggle("active");
  if(id==="studio") $("selFilterType").value = pill.classList.contains("active") ? "studio" : "all";
  if(id==="outdoor") $("selFilterType").value = pill.classList.contains("active") ? "outdoor" : "all";
  if(id==="texture") $("selFilterType").value = pill.classList.contains("active") ? "texture" : "all";
  if(id==="tileable") $("txtSearch").value = pill.classList.contains("active") ? "tileable seamless" : "";
  if(id==="copyspace") $("txtSearch").value = pill.classList.contains("active") ? "copy space" : "";
  renderLibrary();
});

["selProduct","selLang","selTemplate","selMaterial","selComposition","selLight","selQuality",
 "chkTileable","chkCopySpace","chkMinimal","txtExtra","txtNegExtra"].forEach(id=>{
  $(id).addEventListener("input", buildFromForm);
  $(id).addEventListener("change", buildFromForm);
});

$("txtSearch").addEventListener("input", renderLibrary);
$("selFilterType").addEventListener("change", renderLibrary);

$("selTemplate").addEventListener("change", ()=>{
  const tid = $("selTemplate").value;
  if(tid.startsWith("texture-")){ $("selComposition").value = "top-down"; $("chkTileable").checked = true; }
  else if(tid.startsWith("outdoor-")){ $("chkTileable").checked = false; }
  else if(tid.startsWith("studio-")){ $("selComposition").value = tid==="studio-wall" ? "front wall" : "wall+table"; $("chkCopySpace").checked = true; }
  buildFromForm();
});

(function init(){
  $("selTemplate").value = "studio-wall-table";
  $("selComposition").value = "wall+table";
  $("selLight").value = "day-left";
  $("selQuality").value = "sd15";
  $("outNeg").value = DEFAULT_NEG;
  buildFromForm();
  renderLibrary();
})();
</script>
</body>
</html>
